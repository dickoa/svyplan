% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/varcomp.R
\name{varcomp}
\alias{varcomp}
\alias{varcomp.formula}
\alias{varcomp.default}
\alias{varcomp.survey.design}
\title{Estimate Variance Components}
\usage{
varcomp(x, ...)

\method{varcomp}{formula}(x, ..., data = NULL, prob = NULL)

\method{varcomp}{default}(x, ..., stage_id = NULL, prob = NULL)

\method{varcomp}{survey.design}(x, ..., prob = NULL)
}
\arguments{
\item{x}{A formula, numeric vector, or survey design object
(see Details).}

\item{...}{Additional arguments passed to methods.}

\item{data}{A data frame (required for formula interface).}

\item{prob}{First-stage selection probabilities. A one-sided formula
(e.g., \code{~pp}) when using the formula interface, or a numeric vector.
\code{NULL} (default) assumes SRS.}

\item{stage_id}{A list of stage-ID vectors (required for vector interface).
Length determines the number of stage boundaries (stages - 1).}
}
\value{
A \code{svyplan_varcomp} object with components:
\describe{
\item{\code{varb}}{Between-PSU variance (scalar).}
\item{\code{varw}}{Within-PSU variance. Scalar for 2-stage, length-2
vector (\code{varw_psu}, \code{varw_ssu}) for 3-stage.}
\item{\code{delta}}{Measure of homogeneity. Length 1 for 2-stage,
length 2 (\code{delta_psu}, \code{delta_ssu}) for 3-stage.}
\item{\code{k}}{Ratio parameter(s), same length as \code{delta}
(\code{k_psu}, \code{k_ssu} for 3-stage).}
\item{\code{rel_var}}{Unit relvariance (scalar).}
\item{\code{stages}}{Number of stages (2 or 3).}
}
}
\description{
Estimate between- and within-stage variance components using nested
ANOVA decomposition. Supports SRS and PPS first-stage designs.
}
\details{
The interface is determined by the class of \code{x}:
\itemize{
\item \strong{Formula}: \code{varcomp(income ~ district, data = frame)}. The LHS is
the analysis variable, RHS terms are stage IDs (outermost first).
\item \strong{Numeric vector}: \code{varcomp(y, stage_id = list(cluster_ids))}.
\item \strong{survey.design}: \code{varcomp(design, ~y)}. Cluster structure is
extracted from the design object. Requires the survey package.
}

When \code{prob} is \code{NULL}, SRS first-stage is assumed. When provided, PPS
variance estimation is used.

The returned \code{delta} is the measure of homogeneity
\eqn{\delta = V_b / (V_b + V_w)}{delta = Vb / (Vb + Vw)} following
Valliant, Dever, and Kreuter (2018, Ch. 9). Unlike the traditional ANOVA
intraclass correlation coefficient, \code{delta} is constrained to \eqn{[0, 1]}
and should not be compared directly to mixed-model ICCs (e.g. from lme4)
which can be negative.

Clusters containing a single observation have undefined within-cluster
variance. In this case, the within-cluster variance is imputed as the
mean variance of the remaining clusters.
}
\section{Methods (by class)}{
\itemize{
\item \code{varcomp(formula)}: Method for formula interface.

\item \code{varcomp(default)}: Default method for numeric vectors.

\item \code{varcomp(survey.design)}: Method for survey design objects. Pass a one-sided
formula (e.g., \code{~y}) to specify the outcome variable. Cluster
structure is extracted from the design.

}}
\examples{
# 2-stage SRS using formula
set.seed(42)
frame <- data.frame(
  income = rnorm(200, 50000, 10000),
  district = rep(1:20, each = 10)
)
vc <- varcomp(income ~ district, data = frame)
vc

# Feed into n_cluster
n_cluster(cost = c(500, 50), delta = vc, budget = 100000)

}
\references{
Valliant, R., Dever, J. A., and Kreuter, F. (2018).
\emph{Practical Tools for Designing and Weighting Survey Samples}
(2nd ed.). Springer. Ch. 9.

Hansen, M. H., Hurwitz, W. N., and Madow, W. G. (1953).
\emph{Sample Survey Methods and Theory} (Vol. I). Wiley.
}
\seealso{
\code{\link[=n_cluster]{n_cluster()}} which accepts a \code{svyplan_varcomp} as \code{delta}.
}
